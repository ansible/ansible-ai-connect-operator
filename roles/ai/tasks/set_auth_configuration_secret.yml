---
# Determine and set Authentication configuration secret
- name: Check for custom Authentication configuration
  k8s_info:
    kind: Secret
    namespace: '{{ ansible_operator_meta.namespace }}'
    name: '{{ auth_config.auth_secret_name }}'
  register: _custom_auth_config_resources
  when:
    - auth_config is defined
    - auth_config | length
    - auth_config.auth_secret_name is defined
    - auth_config.auth_secret_name | length
  no_log: "{{ no_log }}"

# Always generate the Secret, if a custom one is not being used, in case any
# configuration parameter on the AnsibleAIConnect definition has changed.
- block:
    - name: Create Authentication configuration
      k8s:
        apply: true
        definition: "{{ lookup('template', 'secrets/auth.secret.yaml.j2') }}"
      no_log: "{{ no_log }}"

    - name: Read Authentication Configuration
      k8s_info:
        kind: Secret
        namespace: '{{ ansible_operator_meta.namespace }}'
        name: '{{ ansible_operator_meta.name }}-auth-configuration'
      register: _generated_auth_config_resources
      no_log: "{{ no_log }}"
  when: not _custom_auth_config_resources['resources'] | default([]) | length

- name: Set Authentication Configuration
  set_fact:
    auth_config: '{{ _generated_auth_config_resources["resources"] | default([]) | length | ternary(_generated_auth_config_resources, _custom_auth_config_resources) }}'
  no_log: "{{ no_log }}"

- name: Set actual Authentication configuration secret used
  set_fact:
    __auth_secret_name: "{{ auth_config['resources'][0]['metadata']['name'] }}"
