---
- name: Apply Chatbot ConfigMap resources
  k8s:
    apply: yes
    definition: "{{ lookup('template', 'chatbot.configmap.yaml.j2') }}"
    wait: yes

- name: Apply underlying service ConfigMap resources
  k8s:
    apply: yes
    definition: "{{ lookup('template', 'chatbot.configmap.chatbot.yaml.j2') }}"
    wait: yes

- name: Apply deployment resources
  k8s:
    apply: yes
    definition: "{{ lookup('template', item + '.yaml.j2') }}"
    wait: no
  loop:
    - 'chatbot.service'
    - 'chatbot.deployment'
    - 'chatbot.ingress'

- name: Check for Chatbot Pod
  k8s_info:
    kind: Pod
    api_version: v1
    namespace: "{{ ansible_operator_meta.namespace }}"
    label_selectors:
      - "app.kubernetes.io/name={{ ansible_operator_meta.name }}"
      - "app.kubernetes.io/managed-by={{ deployment_type }}-operator-chatbot"
      - "app.kubernetes.io/component={{ deployment_type }}-chatbot"
    field_selectors:
      - status.phase=Running
  register: chatbot_pod
  until:
    - "chatbot_pod['resources'] | length"
    - "chatbot_pod['resources'][0]['status']['phase'] == 'Running'"
    - "chatbot_pod['resources'][0]['status']['containerStatuses'][0]['ready'] == true"
  retries: 60
  delay: 5

- name: Set the Chatbot Pod name as a variable.
  set_fact:
    chatbot_pod_name: "{{ chatbot_pod['resources'][0]['metadata']['name'] | default('') }}"
