---
apiVersion: v1
kind: ConfigMap
metadata:
  name: '{{ ansible_operator_meta.name }}-{{ deployment_type }}-lightspeed-stack-config'
  namespace: '{{ ansible_operator_meta.namespace }}'
  labels:
    {{ lookup("template", "../common/templates/labels/common.yaml.j2") | indent(width=4) | trim }}
  annotations:
    checksum-secret-chatbot_config: "{{ lookup('ansible.builtin.vars', 'chatbot_config', default='')["resources"][0]["data"] | default('') | sha1 }}"
data:
  lightspeed-stack.yaml: |
    name: Ansible Lightspeed Intelligent Assistant
    service:
      host: 0.0.0.0
      port: 8321
      auth_enabled: false
      workers: 1
      color_log: true
      access_log: true
{% if is_openshift %}
      tls_config:
        tls_certificate_path: /app-root/certs/tls.crt
        tls_key_path: /app-root/certs/tls.key
{% endif %}
    llama_stack:
      use_as_library_client: true
      library_client_config_path: /.llama/distributions/llama-stack/config/ansible-chatbot-run.yaml
    user_data_collection:
      feedback_disabled: true
      transcripts_disabled: true
    customization:
      system_prompt_path: /.llama/distributions/ansible-chatbot/system-prompts/default.txt
{% if _aap_gateway_url is defined or _aap_controller_url is defined %}
    mcp_servers:
{% if _aap_gateway_url is defined and _aap_controller_url is defined %}
      - name: mcp::aap-controller
        provider_id: model-context-protocol
        url: http://127.0.0.1:8004/sse
{% endif %}
{% if _aap_gateway_url is defined %}
      - name: mcp::aap-lightspeed
        provider_id: model-context-protocol
        url: http://127.0.0.1:8005/sse
{% endif %}
{% endif %}
